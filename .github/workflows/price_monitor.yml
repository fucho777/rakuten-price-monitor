name: æ¥½å¤©ä¾¡æ ¼ç›£è¦–ã¨æŠ•ç¨¿

on:
  schedule:
    - cron: '0 */3 * * *'  # 3æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«

jobs:
  monitor-and-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # GitHubãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹æ¨©é™ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—
      
      - name: æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—
        run: |
          git pull origin main
        
      - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
          
      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: é€šçŸ¥å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        run: |
          if [ ! -f "notification_history.json" ]; then
            echo "{}" > notification_history.json
            echo "é€šçŸ¥å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ"
          fi
          
      - name: å®Ÿè¡Œå‰ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        run: |
          echo "å®Ÿè¡Œå‰ã®product_list.csvã®å†…å®¹ç¢ºèª:"
          if [ -f "product_list.csv" ]; then
            head -n 5 product_list.csv
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < product_list.csv) ãƒã‚¤ãƒˆ"
            echo "è¡Œæ•°: $(wc -l < product_list.csv) è¡Œ"
          else
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
          
      - name: æ¥½å¤©å•†å“ä¾¡æ ¼ç›£è¦–ã‚’å®Ÿè¡Œ
        env:
          RAKUTEN_APP_ID: ${{ secrets.RAKUTEN_APP_ID }}
          RAKUTEN_AFFILIATE_ID: ${{ secrets.RAKUTEN_AFFILIATE_ID }}
          PRICE_CHANGE_THRESHOLD: ${{ secrets.PRICE_CHANGE_THRESHOLD || '5' }}
        run: python monitor.py
        
      - name: å®Ÿè¡Œå¾Œã®CSVãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        run: |
          echo "å®Ÿè¡Œå¾Œã®product_list.csvã®å†…å®¹ç¢ºèª:"
          if [ -f "product_list.csv" ]; then
            head -n 5 product_list.csv
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < product_list.csv) ãƒã‚¤ãƒˆ"
            echo "è¡Œæ•°: $(wc -l < product_list.csv) è¡Œ"
            echo "æœ€çµ‚æ›´æ–°æ™‚åˆ»: $(stat -c %y product_list.csv)"
          else
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
        
      - name: ã‚¹ãƒ¬ãƒƒã‚ºã«æŠ•ç¨¿
        env:
          THREADS_APP_ID: ${{ secrets.THREADS_APP_ID }}
          THREADS_APP_SECRET: ${{ secrets.THREADS_APP_SECRET }}
          THREADS_LONG_LIVED_TOKEN: ${{ secrets.THREADS_LONG_LIVED_TOKEN }}
          THREADS_INSTAGRAM_ACCOUNT_ID: ${{ secrets.THREADS_INSTAGRAM_ACCOUNT_ID }}
        run: python threads_poster.py
        
      # TwitteræŠ•ç¨¿ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ã§æœ‰åŠ¹åŒ–ï¼‰
      #- name: X(Twitter)ã«æŠ•ç¨¿
      #  env:
      #    TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
      #    TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
      #    TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
      #    TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
      #  run: python twitter_poster.py
        
      - name: JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        run: |
          echo "notifiable_products.jsonã®å†…å®¹ç¢ºèª:"
          if [ -f "notifiable_products.json" ]; then
            cat notifiable_products.json
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < notifiable_products.json) ãƒã‚¤ãƒˆ"
          else
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
          
          echo "notification_history.jsonã®å†…å®¹ç¢ºèª:"
          if [ -f "notification_history.json" ]; then
            cat notification_history.json
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -c < notification_history.json) ãƒã‚¤ãƒˆ"
          else
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
          
      - name: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        run: |
          echo "æœ€çµ‚å®Ÿè¡Œ: $(date "+%Y-%m-%d %H:%M:%S")" > last_run.txt
        
      - name: ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’å¼·åˆ¶çš„ã«ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # å¤‰æ›´ã«é–¢ä¿‚ãªãã€last_updatedå€¤ã‚’æ›´æ–°ã—ã¦å¼·åˆ¶çš„ã«å¤‰æ›´ã‚’ä½œã‚‹
          echo "æœ€çµ‚æ›´æ–°: $(date)" > last_updated.txt
          
          # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¼·åˆ¶çš„ã«è¿½åŠ 
          git add -f product_list.csv
          git add -f last_updated.txt
          git add -f threads_posting_log.csv
          git add -f notification_history.json
          git add -f notifiable_products.json
          
          # å¼·åˆ¶çš„ã«ã‚³ãƒŸãƒƒãƒˆ
          git commit --allow-empty -m "ğŸ¤– ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°: $(date +%Y-%m-%d-%H:%M)"
          git push origin main
